@{
    ViewData["Title"] = "";
}
<h1>@ViewData["Title"]</h1>

@* <div class="container mt-5">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-body">
                    <h2 class="card-title text-center">Registro</h2>

                    <!-- Sección Compra -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <h5>Compra</h5>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <ul>
                                        <li>Línea 1</li>
                                        <li>Línea 2</li>
                                        <li>Línea 3</li>
                                        <li>Línea 4</li>
                                        <li>Línea 5</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-primary">Consultar</button>
                        </div>
                    </div>

                    <!-- Sección Saldo Anterior -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <h5>Saldo Anterior</h5>
                        </div>
                        <div class="col-md-8">
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="Saldo anterior" readonly>
                                <div class="input-group-append">
                                    <span class="input-group-text">$</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sección Abono -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <h5>Abono</h5>
                        </div>
                        <div class="col-md-8">
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="Monto a abonar">
                            </div>
                        </div>
                    </div>
                    <!-- Botón Abonar -->
                    <div class="row mb-3 text-center">
                        <div class="col-md-12">
                            <button class="btn btn-success">Abonar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>*@




<form method="post">
    <div class="form-group">
        <label for="Id_Compra">Purchase</label>
        <select id="Id_Compra" name="Id_Compra" class="form-control" asp-items="@(new SelectList(Model.Purchases, "Id_Compra", "Descripcion"))">
            <option value="">Select a purchase</option>
        </select>
    </div>
    <div class="form-group">
        <label for="PreviousBalance">Previous Balance</label>
        <input type="text" id="PreviousBalance" name="PreviousBalance" class="form-control" readonly />
    </div>
    <div class="form-group">
        <label for="Credit">Credit</label>
        <input type="number" id="Credit" name="Credit" class="form-control" required />
    </div>
    <button type="submit" class="btn btn-primary">Pay</button>
</form>

@section Scripts {
    <script>
        $(document).ready(function () {
            LoadPurchases();

            $('#Id_Compra').change(function () {
                LoadPreviousBalance($(this).val());
            });
        });

        $('form').submit(function (e) {
            e.preventDefault();

            // Get the form data
            var formData = {
                Id_Compra: $('#Id_Compra').val(),
                Monto: $('#Credit').val()
            };

            // Execute the stored procedure
            ExecuteStoredProcedure(formData);
        });

        function LoadPurchases() {
            $.ajax({
                type: 'GET',
                url: '/Principal',
                success: function (data) {
                    var select = $('#Id_Compra');
                    select.empty();
                    select.append('<option value="">Seleccione una compra</option>');

                    $.each(data, function (index, item) {
                        if (item.Estado === 'Pendiente') {
                            select.append('<option value="' + item.Id_Compra + '">' + item.Descripcion + '</option>');
                        }
                    });
                }
            });
        }

        function LoadPreviousBalance(idCompra) {
            if (idCompra) {
                $.ajax({
                    type: 'GET',
                    url: '/Principal/ObtenerBalance',
                    data: { idCompra: idCompra },
                    success: function (data) {
                        $('#PreviousBalance').val(data);
                    }
                });
            } else {
                $('#PreviousBalance').val('');
            }
        }
        function ExecuteStoredProcedure(formData) {
            $.ajax({
                type: 'POST',
                url: '/Abono',
                data: formData,
                success: function (data) {
                    if (data.success) {
                        // Redirect to the Consultation view
                        window.location.href = '/Principal';
                    } else {
                        // Display an error message
                        alert('Error registering payment.');
                    }
                }
            });
        }
    </script>
}
